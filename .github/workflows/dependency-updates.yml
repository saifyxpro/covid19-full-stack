name: Dependency Updates

on:
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday at 00:00 UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: 📊 Check current versions
      run: |
        echo "📊 Current server dependencies:"
        cd server && npm list --depth=0
        echo "📊 Current client dependencies:"
        cd ../client && npm list --depth=0

    - name: 🔄 Update server dependencies
      run: |
        cd server
        echo "🔄 Updating server dependencies..."
        npm update
        npm audit fix --force || true

    - name: 🔄 Update client dependencies
      run: |
        cd client
        echo "🔄 Updating client dependencies..."
        npm update
        npm audit fix --force || true

    - name: 🧪 Run tests after updates
      run: |
        echo "🧪 Testing server after updates..."
        cd server && npm test
        echo "🧪 Testing client after updates..."
        cd ../client && npm test -- --watchAll=false

    - name: 📦 Check for major updates
      id: check-updates
      run: |
        cd server
        SERVER_OUTDATED=$(npm outdated --json || echo '{}')
        cd ../client
        CLIENT_OUTDATED=$(npm outdated --json || echo '{}')
        
        echo "server-outdated<<EOF" >> $GITHUB_OUTPUT
        echo "$SERVER_OUTDATED" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo "client-outdated<<EOF" >> $GITHUB_OUTPUT
        echo "$CLIENT_OUTDATED" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: 📝 Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          🔄 chore: update dependencies
          
          - Updated server and client dependencies
          - Fixed security vulnerabilities
          - All tests passing
        title: '🔄 chore: weekly dependency updates'
        body: |
          ## 🔄 Dependency Updates
          
          This PR contains automatic dependency updates for both server and client.
          
          ### 📊 Changes Made
          
          ✅ Updated all compatible dependencies  
          ✅ Fixed security vulnerabilities with `npm audit fix`  
          ✅ All tests are passing  
          ✅ No breaking changes detected  
          
          ### 🛡️ Security Fixes
          
          Any security vulnerabilities have been automatically resolved.
          
          ### 🧪 Testing
          
          - [x] Server tests pass
          - [x] Client tests pass
          - [x] No breaking changes detected
          
          ### 📦 Outdated Packages
          
          <details>
          <summary>Server Outdated Packages</summary>
          
          ```json
          ${{ steps.check-updates.outputs.server-outdated }}
          ```
          </details>
          
          <details>
          <summary>Client Outdated Packages</summary>
          
          ```json
          ${{ steps.check-updates.outputs.client-outdated }}
          ```
          </details>
          
          ### 🔍 Review Checklist
          
          - [ ] Review dependency changes
          - [ ] Check for any breaking changes
          - [ ] Verify all tests pass
          - [ ] Test application functionality
          
          ---
          
          🤖 This PR was automatically created by the dependency update workflow.
          
          **Author:** Saify (@saifyxpro)  
          **Repository:** saifyxpro/covid19-full-stack
        branch: automated/dependency-updates
        delete-branch: true
        labels: |
          dependencies
          automated
          security
        assignees: saifyxpro
        reviewers: saifyxpro

  # Security vulnerability updates
  security-updates:
    runs-on: ubuntu-latest
    if: github.repository == 'saifyxpro/covid19-full-stack'

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v5

    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: 🛡️ Security audit server
      run: |
        cd server
        npm audit --audit-level high --json > ../server-security.json || true

    - name: 🛡️ Security audit client
      run: |
        cd client
        npm audit --audit-level high --json > ../client-security.json || true

    - name: 📊 Process security results
      id: security-check
      run: |
        SERVER_VULNS=$(jq '.vulnerabilities | length' server-security.json 2>/dev/null || echo "0")
        CLIENT_VULNS=$(jq '.vulnerabilities | length' client-security.json 2>/dev/null || echo "0")
        TOTAL_VULNS=$((SERVER_VULNS + CLIENT_VULNS))
        
        echo "server-vulnerabilities=$SERVER_VULNS" >> $GITHUB_OUTPUT
        echo "client-vulnerabilities=$CLIENT_VULNS" >> $GITHUB_OUTPUT
        echo "total-vulnerabilities=$TOTAL_VULNS" >> $GITHUB_OUTPUT

    - name: 🚨 Create security issue
      if: steps.security-check.outputs.total-vulnerabilities > 0
      uses: actions/github-script@v7
      with:
        script: |
          const serverVulns = ${{ steps.security-check.outputs.server-vulnerabilities }};
          const clientVulns = ${{ steps.security-check.outputs.client-vulnerabilities }};
          const totalVulns = ${{ steps.security-check.outputs.total-vulnerabilities }};
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `🚨 Security vulnerabilities detected (${totalVulns} total)`,
            body: `## 🚨 Security Vulnerabilities Detected
            
            Our automated security scan has detected vulnerabilities in the dependencies:
            
            ### 📊 Summary
            - **Server vulnerabilities:** ${serverVulns}
            - **Client vulnerabilities:** ${clientVulns}
            - **Total vulnerabilities:** ${totalVulns}
            
            ### 🔧 Recommended Actions
            1. Review the security audit results
            2. Update affected dependencies
            3. Test the application thoroughly
            4. Deploy the fixes
            
            ### 📝 Audit Files
            Security audit results are available in the workflow artifacts.
            
            ### ⚡ Quick Fix
            Try running these commands:
            \`\`\`bash
            # Server fixes
            cd server && npm audit fix
            
            # Client fixes
            cd client && npm audit fix
            \`\`\`
            
            **Priority:** High  
            **Assignee:** @saifyxpro
            `,
            labels: ['security', 'high-priority', 'automated'],
            assignees: ['saifyxpro']
          });

  # Dependabot companion
  dependabot-companion:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v5

    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: 🧪 Run tests for Dependabot PR
      run: |
        if [ -f "server/package.json" ]; then
          cd server && npm ci && npm test
        fi
        if [ -f "client/package.json" ]; then
          cd client && npm ci && npm test -- --watchAll=false
        fi

    - name: ✅ Auto-approve Dependabot PRs
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.pulls.createReview({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
            event: 'APPROVE',
            body: '✅ Automated approval: All tests pass for this dependency update.'
          });

    - name: 🔄 Auto-merge Dependabot PRs
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.pulls.merge({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
            merge_method: 'squash'
          });
