name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 1' # Weekly on Monday

jobs:
  # Code Quality Analysis
  code-quality:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          server/node_modules
          client/node_modules
          ~/.npm
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: ğŸ“¦ Install dependencies
      run: |
        cd server && npm ci
        cd ../client && npm ci

    - name: ğŸ” ESLint Analysis
      run: |
        echo "ğŸ” Running ESLint on server..."
        cd server && npm run lint -- --format json --output-file ../eslint-server.json || true
        echo "ğŸ” Running ESLint on client..."
        cd ../client && npm run lint -- --format json --output-file ../eslint-client.json || true

    - name: ğŸ§ª Test Coverage
      run: |
        echo "ğŸ§ª Running server tests with coverage..."
        cd server && npm run test:coverage
        echo "ğŸ§ª Running client tests with coverage..."
        cd ../client && npm test -- --coverage --watchAll=false

    - name: ğŸ“Š SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    - name: ğŸ“ˆ Codacy Analysis
      uses: codacy/codacy-analysis-cli-action@master
      with:
        project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
        upload: true
        max-allowed-issues: 2147483647

  # Dependency Check
  dependency-check:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ›¡ï¸ Server Security Audit
      run: |
        cd server
        npm audit --audit-level high
        npm audit --json > ../server-audit.json || true

    - name: ğŸ›¡ï¸ Client Security Audit
      run: |
        cd client
        npm audit --audit-level high
        npm audit --json > ../client-audit.json || true

    - name: ğŸ“¦ Check for outdated packages
      run: |
        echo "ğŸ“¦ Checking server packages..."
        cd server && npm outdated --json > ../server-outdated.json || true
        echo "ğŸ“¦ Checking client packages..."
        cd ../client && npm outdated --json > ../client-outdated.json || true

    - name: ğŸ“Š Upload audit results
      uses: actions/upload-artifact@v3
      with:
        name: security-audits
        path: |
          server-audit.json
          client-audit.json
          server-outdated.json
          client-outdated.json

  # Performance Testing
  performance:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ“¦ Install dependencies
      run: |
        cd server && npm ci
        cd ../client && npm ci

    - name: ğŸ—ï¸ Build client
      run: |
        cd client
        npm run build

    - name: ğŸš€ Start server for testing
      run: |
        cd server
        npm start &
        sleep 10
      env:
        NODE_ENV: production
        MONGODB_URI: mongodb://localhost:27017/covid19_perf_test

    - name: âš¡ Run Lighthouse CI
      uses: treosh/lighthouse-ci-action@v9
      with:
        configPath: './lighthouse-ci.json'
        uploadArtifacts: true
        temporaryPublicStorage: true

  # Bundle Analysis
  bundle-analysis:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ“¦ Install client dependencies
      run: |
        cd client
        npm ci

    - name: ğŸ“Š Analyze bundle size
      run: |
        cd client
        npm run build
        npx webpack-bundle-analyzer build/static/js/*.js --report --mode static --report-filename ../bundle-report.html

    - name: ğŸ“Š Upload bundle analysis
      uses: actions/upload-artifact@v3
      with:
        name: bundle-analysis
        path: bundle-report.html

  # Accessibility Testing
  accessibility:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ“¦ Install client dependencies
      run: |
        cd client
        npm ci

    - name: ğŸ—ï¸ Build client
      run: |
        cd client
        npm run build

    - name: â™¿ Run accessibility tests
      run: |
        cd client
        npm run test:a11y || true

    - name: â™¿ Axe accessibility check
      uses: dequelabs/axe-action@v2.1-0
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        github-token: ${{ secrets.GITHUB_TOKEN }}
